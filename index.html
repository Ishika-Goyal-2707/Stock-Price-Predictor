<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Price Predictor</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>ðŸ“Š Stock Price Predictor</h1>

    <form id="stockForm">
      <input type="text" name="ticker" placeholder="Enter Stock Symbol (e.g. RELIANCE.NS, AAPL)" required>
      <button type="submit">Show Chart</button>
    </form>

    <div class="range-buttons">
      <button type="button" onclick="setRange(30)">1M</button>
      <button type="button" onclick="setRange(90)">3M</button>
      <button type="button" onclick="setRange(180)">6M</button>
      <button type="button" onclick="setRange(365)">1Y</button>
      <button type="button" onclick="setRange(9999)">ALL</button>
    </div>

    <canvas id="stockChart"></canvas>
    <p id="error" class="error"></p>

    <!-- ðŸ“ˆ Forecast Table -->
    <div id="forecastContainer" style="display:none; margin-top: 30px;">
      <h2>ðŸ“… Next 5-Day Price Forecast</h2>
      <table id="forecastTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Predicted Price (â‚¹)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let chart;
    let fullData = {};
    let visibleDays = 9999;

    function setRange(days) {
      visibleDays = days;
      if (fullData.dates) updateChart();
    }

    document.getElementById("stockForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const res = await fetch("/predict", { method: "POST", body: formData });
      const data = await res.json();

      if (data.error) {
        document.getElementById("error").innerText = data.error;
        document.getElementById("forecastContainer").style.display = "none";
        return;
      }

      fullData = data.chart_data;
      document.getElementById("error").innerText = "";
      updateChart();
      updateForecastTable();
    });

    function updateChart() {
      const { dates, close, ma10, ma30, pred_dates, pred_values } = fullData;
      const totalPoints = dates.length;
      const startIdx = Math.max(0, totalPoints - visibleDays);

      const displayDates = dates.slice(startIdx);
      const displayClose = close.slice(startIdx);
      const displayMA10 = ma10.slice(startIdx);
      const displayMA30 = ma30.slice(startIdx);

      const ctx = document.getElementById("stockChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [...displayDates, ...pred_dates],
          datasets: [
            { label: "Close Price", data: [...displayClose, ...Array(pred_dates.length).fill(null)], borderColor: "deepskyblue", tension: 0.2 },
            { label: "MA10", data: [...displayMA10, ...Array(pred_dates.length).fill(null)], borderColor: "limegreen", borderDash: [4,2], tension: 0.2 },
            { label: "MA30", data: [...displayMA30, ...Array(pred_dates.length).fill(null)], borderColor: "violet", borderDash: [4,2], tension: 0.2 },
            { label: "Predicted (Next 5 Days)", data: [...Array(displayDates.length).fill(null), ...pred_values], borderColor: "orange", borderDash: [6,3], tension: 0.2 }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          scales: { x: { display: true }, y: { display: true } },
          plugins: { legend: { position: "top" }, title: { display: true, text: "Stock Price Chart (with 5-Day Forecast)" } }
        }
      });
    }

    function updateForecastTable() {
  const { pred_dates, pred_values } = fullData;
  const tableBody = document.querySelector("#forecastTable tbody");
  tableBody.innerHTML = "";

  pred_dates.forEach((date, i) => {
    const price = pred_values[i];
    const prevPrice = i === 0 ? pred_values[0] : pred_values[i - 1];
    let trend = "";
    let color = "";

    if (i > 0) {
      if (price > prevPrice) {
        trend = "â–²";
        color = "green";
      } else if (price < prevPrice) {
        trend = "â–¼";
        color = "red";
      } else {
        trend = "â–¬";
        color = "gray";
      }
    } else {
      trend = "â€¢";
      color = "gray";
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${date}</td>
      <td style="color:${color}; font-weight:600;">
        â‚¹${price.toFixed(2)} ${trend}
      </td>
    `;
    tableBody.appendChild(row);
  });

  document.getElementById("forecastContainer").style.display = "block";
}

  </script>
</body>
</html>
